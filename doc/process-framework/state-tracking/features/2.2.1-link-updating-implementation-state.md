---
id: PF-FEA-051
type: Process Framework
category: Feature Implementation State
version: 2.0
created: 2026-02-21
updated: 2026-02-21
feature_name: Link Updating
implementation_mode: Retrospective Analysis
feature_id: 2.2.1
status: Retrospective Analysis
consolidates:
  - PF-FEA-021 (2.2.1 Link Updater)
  - PF-FEA-022 (2.2.2 Relative Path Calculation)
  - PF-FEA-023 (2.2.3 Anchor Preservation)
  - PF-FEA-024 (2.2.4 Dry-Run Mode)
  - PF-FEA-025 (2.2.5 Backup Creation)
---

# Link Updating - Implementation State

> **ðŸ“– Usage guide**: [Feature Implementation State Tracking Guide (PF-GDE-043)](../../guides/guides/feature-implementation-state-tracking-guide.md)
>
> **Retrospective Analysis mode** (onboarding tasks [PF-TSK-064](../../tasks/00-onboarding/codebase-feature-discovery.md), [PF-TSK-065](../../tasks/00-onboarding/codebase-feature-analysis.md), [PF-TSK-066](../../tasks/00-onboarding/retrospective-documentation-creation.md)):
> - Section 3 tracks analysis progress rather than planned tasks
> - Section 5 (Code Inventory) is the primary deliverable â€” every file must be assigned
> - Section 7 documents decisions discovered in code, not planned decisions
> - All content is descriptive ("what is") rather than prescriptive ("what should be")

> **v2.0 Consolidation**: This file replaces 5 former feature states (PF-FEA-021 through PF-FEA-025, old 2.2.1â€“2.2.5) as part of the 42â†’9 feature consolidation. See [Feature Consolidation State](../temporary/feature-consolidation-state.md).

---

## 1. Feature Overview

### Feature Description

The Link Updating feature handles the actual modification of files to update references when a target file has moved. The core class `LinkUpdater` (`updater.py`) receives a `FileOperation` (old_path, new_path) and a list of affected `LinkReference` objects, then updates each source file to reflect the new target location.

Key capabilities include:
- **Relative path calculation**: Computes the correct new relative path from each source file to the moved target's new location
- **Bottom-to-top line sorting**: Processes link replacements from the bottom of a file upward, ensuring line number offsets remain valid even when replacements change line lengths
- **Atomic writes**: Writes changes to a temporary file first, then renames it over the original â€” preventing partial writes if the process is interrupted
- **Backup creation**: Creates `.bak` copies of files before modification
- **Dry-run mode**: Logs what would change without modifying any files
- **Anchor preservation**: Preserves `#fragment` anchors when updating link paths
- **Link-type dispatch**: Different update strategies for markdown links, YAML values, JSON values, Python imports, etc.

### Business Value

- **User Need**: When a file moves, all references must be updated accurately and safely â€” no broken links, no data loss.
- **Business Goal**: Zero-risk automated link updates with rollback capability.
- **Success Metrics**: All affected references updated correctly; no file corruption; backups available for rollback; dry-run shows accurate preview.

### Scope

**In Scope**:

- `LinkUpdater` class with file modification logic
- Relative path calculation from source to moved target
- Bottom-to-top line processing for stable offsets
- Atomic write-then-rename file modification
- Backup file creation (`.bak`)
- Dry-run mode (preview without modification)
- Anchor/fragment preservation
- Link-type-aware replacement strategies

**Out of Scope**:

- Move detection (â†’ 1.1.1 File System Monitoring)
- Link discovery (â†’ 2.1.1 Link Parsing System)
- Link storage (â†’ 0.1.2 In-Memory Link Database)

---

## 2. Current State Summary

**Last Updated**: 2026-02-21
**Current Status**: MAINTAINED (retrospective analysis â€” pre-framework implementation)
**Current Task**: Feature Consolidation (Structure Change)
**Completion**: 100% (fully deployed, in production use)

### What's Working

- [âœ“] Relative path calculation for all supported formats
- [âœ“] Bottom-to-top line sorting for safe in-place editing
- [âœ“] Atomic writes via temp-file-then-rename
- [âœ“] Backup creation before modification
- [âœ“] Dry-run mode with accurate preview
- [âœ“] Anchor preservation in link updates
- [âœ“] Link-type dispatch for format-specific replacement

### What's In Progress

- [âš™] Feature consolidation â€” state file created as part of 42â†’9 consolidation

### What's Blocked

_Nothing blocked._

---

## 3. Implementation Progress

### Retrospective Analysis Progress

> **Note**: This feature was implemented before the process framework was established.

- [âœ…] **PF-TSK-064**: Codebase Feature Discovery â€” Code Inventory populated (2026-02-17)
- [âœ…] **PF-TSK-065**: Codebase Feature Analysis â€” Dependencies and Design Decisions documented (2026-02-18)
- [âœ…] **PF-TSK-066**: Retrospective Documentation Creation â€” Tier Assessment (ART-ASS-196), FDD (PD-FDD-027), TDD (PD-TDD-026) created (2026-02-19/20)
- [âœ…] **Feature Consolidation**: Merged 2.2.1â€“2.2.5 into unified feature, new state file created (2026-02-21)

---

## 4. Documentation Inventory

### Design Documentation

| Document | Type | Status | Location | Last Updated |
| -------- | ---- | ------ | -------- | ------------ |
| Tier Assessment (ART-ASS-196) | Tier Assessment | Complete | [ART-ASS-196](../../methodologies/documentation-tiers/assessments/ART-ASS-196-2-2-1-link-updating.md) | 2026-02-20 |
| FDD (PD-FDD-027) | Functional Design | Complete | [fdd-2-2-1-link-updater.md](../../../product-docs/functional-design/fdds/fdd-2-2-1-link-updater.md) | 2026-02-19 |
| TDD (PD-TDD-026) | Technical Design | Complete | [tdd-2-2-1-link-updater-t2.md](../../../product-docs/technical/architecture/design-docs/tdd/tdd-2-2-1-link-updater-t2.md) | 2026-02-20 |

### Quick Links

- **Main Design**: [TDD (PD-TDD-026)](../../../product-docs/technical/architecture/design-docs/tdd/tdd-2-2-1-link-updater-t2.md)
- **Related Features**: [1.1.1 File System Monitoring](./1.1.1-file-system-monitoring-implementation-state.md), [2.1.1 Link Parsing System](./2.1.1-link-parsing-system-implementation-state.md)

---

## 5. Code Inventory

### Files Created by This Feature

| File Path | Purpose | Key Components | Status | Created |
| --------- | ------- | -------------- | ------ | ------- |
| [linkwatcher/updater.py](../../../../linkwatcher/updater.py) | Link update engine | `LinkUpdater` class â€” path calc, atomic write, backup, dry-run, anchor preservation | Existing | Pre-framework |

### Test Files

| Test File | Type | Coverage Areas | Status | Created |
| --------- | ---- | -------------- | ------ | ------- |
| [tests/unit/test_updater.py](../../../../tests/unit/test_updater.py) | Unit | Path calculation, replacement, backup, dry-run | Existing | Pre-framework |
| [tests/integration/test_link_updates.py](../../../../tests/integration/test_link_updates.py) | Integration | End-to-end update scenarios | Existing | Pre-framework |

---

## 6. Dependencies

### Feature Dependencies

**This Feature Depends On**:

- **[PF-FEA-046: Core Architecture](./0.1.1-core-architecture-implementation-state.md)** (MAINTAINED)
  - Why: Uses `LinkReference`, `FileOperation` data models and `calculate_relative_path()` utility
  - Impact if unavailable: Cannot represent links or compute new paths

- **[PF-FEA-047: In-Memory Link Database](./0.1.2-in-memory-link-database-implementation-state.md)** (MAINTAINED)
  - Why: Receives affected link references queried from database
  - Impact if unavailable: No links to update

- **[PF-FEA-052: Logging System](./3.1.1-logging-system-implementation-state.md)** (MAINTAINED)
  - Why: Logs all update operations for auditability
  - Impact if unavailable: No update audit trail

**Other Features Depend On This**:

- **[PF-FEA-049: File System Monitoring](./1.1.1-file-system-monitoring-implementation-state.md)** (MAINTAINED)
  - Why: Handler triggers updater when a move is detected
- **[PF-FEA-046: Core Architecture](./0.1.1-core-architecture-implementation-state.md)** (MAINTAINED)
  - Why: Service holds the updater instance

### System Dependencies

**Required Packages**:

| Package | Version | Purpose | Added |
| ------- | ------- | ------- | ----- |
| (stdlib only) | â€” | `os`, `shutil`, `tempfile`, `pathlib` | Pre-framework |

---

## 7. Design Decisions

### Decision 1: Bottom-to-Top Line Processing

**Date**: Pre-framework (discovered in code)
**Context**: When replacing link text in a file, if a replacement changes the line count or character offsets, subsequent replacements on earlier lines would use stale line numbers.

**Decision Made**: Sort replacements by line number descending and process from bottom to top

**Rationale**: Changes at the bottom of a file don't affect line numbers above. Processing bottom-to-top ensures all line numbers remain valid throughout the replacement process.

**Implications**:

- Reliable even when replacements change line lengths
- Slightly more complex sorting step, but guarantees correctness

---

### Decision 2: Atomic Write via Temp-File-Then-Rename

**Date**: Pre-framework (discovered in code)
**Context**: If the process crashes during a file write, the original file could be left in a corrupted state.

**Decision Made**: Write all changes to a temporary file, then rename it over the original (atomic on most file systems)

**Rationale**: On NTFS (Windows), file rename is atomic. If the process crashes during write, the temp file is discarded and the original remains intact.

**Implications**:

- Requires write permission for temp file in the same directory
- Slight overhead from double-write, but ensures data safety

---

### Decision 3: Backup Before Modification

**Date**: Pre-framework (discovered in code)
**Context**: Even with atomic writes, users may want to revert changes.

**Decision Made**: Create `.bak` copy of each file before modification

**Rationale**: Provides an additional safety net. Users can manually restore from `.bak` files if needed.

---

### Decision 4: Dry-Run Mode

**Date**: Pre-framework (discovered in code)
**Context**: Users want to preview what would change before committing to modifications.

**Decision Made**: Configurable dry-run flag that logs all intended changes without modifying files

**Rationale**: Zero-risk preview. Essential for first-time setup and configuration validation.

---

### Implementation Patterns Used

**Safe File Modification Pattern**:

- Pattern: Temp-file write â†’ rename (atomic swap)
- Why: Crash-safe file modification
- Where: `LinkUpdater.update_file()`

**Processing Order Pattern**:

- Pattern: Bottom-to-top line sorting
- Why: Stable line offsets during multi-replacement
- Where: `LinkUpdater._apply_replacements()`

---

## 8. Issues & Resolutions Log

### Tech Debt and Known Limitations

| Item | Type | Reason | Current Mitigation | Priority | Estimated Effort | Future Resolution | Tracked In |
| ---- | ---- | ------ | ------------------ | -------- | ---------------- | ----------------- | ---------- |
| Backup file cleanup | Known Limitation | `.bak` files accumulate over time | Manual cleanup | Low | 1 hour | Add configurable auto-cleanup | â€” |

---

## 9. Next Steps

**Last Updated**: 2026-02-21

### Immediate Next Actions

1. **Create test specification**
   - **Why**: No dedicated test spec exists yet
   - **How**: Use Test Specification Creation task
   - **Estimate**: Medium

---

## 10. Quality Metrics

**Last Updated**: 2026-02-21

### Test Coverage

**Unit Tests**: tests/unit/test_updater.py â€” All passing
**Integration Tests**: tests/integration/test_link_updates.py â€” All passing

---

## 11. API Documentation Reference

### Key Integration Points

**This Feature Exposes**:

- `LinkUpdater` â€” File modification engine
- `update_links()` â€” Main entry point for batch link updates
- Dry-run mode flag for preview

**This Feature Requires**:

- `LinkReference`, `FileOperation` (models.py) â€” Input data types
- `calculate_relative_path()` (utils.py) â€” New path computation
- `get_logger()` (logging.py) â€” Operation logging

---

## 12. Lessons Learned

_Retrospective â€” no lessons captured during original implementation (pre-framework)._
