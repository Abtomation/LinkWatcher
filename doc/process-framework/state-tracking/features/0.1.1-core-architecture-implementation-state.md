---
id: PF-FEA-046
type: Process Framework
category: Feature Implementation State
version: 2.0
created: 2026-02-17
updated: 2026-02-25
feature_name: Core Architecture
implementation_mode: Retrospective Analysis
feature_id: 0.1.1
status: Retrospective Analysis
consolidates:
  - PF-FEA-003 (0.1.1 Core Architecture)
  - PF-FEA-004 (0.1.2 Data Models)
  - PF-FEA-006 (0.1.5 Path Utilities)
---

# Core Architecture - Implementation State

> **ðŸ“– Usage guide**: [Feature Implementation State Tracking Guide (PF-GDE-043)](../../guides/guides/feature-implementation-state-tracking-guide.md)
>
> **Retrospective Analysis mode** (onboarding tasks [PF-TSK-064](../../tasks/00-onboarding/codebase-feature-discovery.md), [PF-TSK-065](../../tasks/00-onboarding/codebase-feature-analysis.md), [PF-TSK-066](../../tasks/00-onboarding/retrospective-documentation-creation.md)):
> - Section 3 tracks analysis progress rather than planned tasks
> - Section 5 (Code Inventory) is the primary deliverable â€” every file must be assigned
> - Section 7 documents decisions discovered in code, not planned decisions
> - All content is descriptive ("what is") rather than prescriptive ("what should be")

> **v2.0 Consolidation**: This file replaces 3 former feature states (PF-FEA-003, PF-FEA-004, PF-FEA-006) as part of the 42â†’9 feature consolidation. See [Feature Consolidation State](../temporary/feature-consolidation-state.md).

---

## 1. Feature Overview

### Feature Description

The Core Architecture feature defines the service-oriented, modular structure of the LinkWatcher system. The central component is `LinkWatcherService` (`service.py`), which acts as the sole orchestrator â€” instantiating and wiring all subsystems together (LinkDatabase, LinkParser, LinkUpdater, LinkMaintenanceHandler, watchdog Observer) in its `__init__()`. The service manages the full application lifecycle: optional initial file scan, file system monitoring startup, SIGINT/SIGTERM signal handling for graceful shutdown, and final statistics reporting.

This feature also encompasses the core data models (`models.py`) that define the fundamental data structures â€” `LinkReference` (dataclass: source_file, target_path, line_number, link_text, link_type) and `FileOperation` (named tuple: old_path, new_path, timestamp) â€” used across all subsystems for link tracking and file event representation.

Additionally, the path utility functions (`utils.py`) provide pure-function path manipulation operations: `normalize_path()` for cross-platform normalization, `calculate_relative_path()` for relative link computation, `is_subpath()` for directory containment checks, and `should_monitor_file()` for filtering logic. The `__init__.py` package manifest provides a clean public API, and `main.py` serves as the CLI entry point with argument parsing and multi-source config loading.

### Business Value

- **User Need**: Developers need links to remain valid after file moves/renames. The service runs as a background process, making link maintenance automatic and invisible.
- **Business Goal**: Provide a self-contained, configurable service that starts with a single command and runs unattended, with well-defined data structures for link representation.
- **Success Metrics**: Service starts reliably; file moves are detected within seconds; graceful shutdown leaves no orphaned processes; duplicate instances are prevented via lock file; data models are consistent across all subsystems.

### Scope

**In Scope**:

- `LinkWatcherService` orchestration class with full lifecycle management
- Package public API via `__init__.py` and `__all__`
- CLI entry point (`main.py`) with argument parsing and multi-source config loading
- Graceful shutdown via POSIX signal handling (SIGINT, SIGTERM)
- Duplicate session prevention via PID-based lock file (`.linkwatcher.lock`)
- Data models: `LinkReference` dataclass and `FileOperation` named tuple
- Path utilities: `normalize_path()`, `calculate_relative_path()`, `is_subpath()`, `should_monitor_file()`
- Status/statistics reporting and force-rescan capability

**Out of Scope**:

- File system event handling logic (â†’ 1.1.1 File System Monitoring)
- Link parsing logic (â†’ 2.1.1 Link Parsing System)
- Link update logic (â†’ 2.2.1 Link Updating)
- In-memory storage (â†’ 0.1.2 In-Memory Link Database)
- Configuration management (â†’ 0.1.3 Configuration System)

---

## 2. Current State Summary

**Last Updated**: 2026-02-25
**Current Status**: MAINTAINED (retrospective analysis â€” pre-framework implementation)
**Current Task**: None (maintenance)
**Completion**: 100% (fully deployed, in production use)

### What's Working

- [âœ“] `LinkWatcherService` orchestrates all components end-to-end
- [âœ“] Initial scan + real-time monitoring pipeline functional
- [âœ“] Graceful shutdown via signal handling
- [âœ“] Public API exports via `__init__.py`
- [âœ“] CLI entry point with multi-source config loading
- [âœ“] `LinkReference` and `FileOperation` data models used by all subsystems
- [âœ“] Path utilities handle cross-platform normalization and relative path computation
- [âœ“] Duplicate session prevention via PID-based lock file (`.linkwatcher.lock`) â€” added 2026-02-25

### What's In Progress

_Nothing in progress._

### What's Blocked

_Nothing blocked._

---

## 3. Implementation Progress

### Retrospective Analysis Progress

> **Note**: This feature was implemented before the process framework was established. The following tracks retrospective documentation tasks only.

- [âœ…] **PF-TSK-064**: Codebase Feature Discovery â€” Code Inventory populated (2026-02-17)
- [âœ…] **PF-TSK-065**: Codebase Feature Analysis â€” Dependencies and Design Decisions documented (2026-02-18)
- [âœ…] **PF-TSK-066**: Retrospective Documentation Creation â€” Tier Assessment (ART-ASS-191), FDD (PD-FDD-022), TDD (PD-TDD-021), ADR (PD-ADR-039), Test Spec (PF-TSP-035) created (2026-02-19/20)
- [âœ…] **Feature Consolidation**: Merged 0.1.1 + 0.1.2 (Data Models) + 0.1.5 (Path Utilities) into unified feature (2026-02-21)
- [âœ…] **PF-TSK-068**: Feature Enhancement â€” Duplicate Session Prevention (PID-based lock file mechanism in `main.py`, updated PowerShell startup script, 10 unit tests) (2026-02-25)

---

## 4. Documentation Inventory

### Design Documentation

| Document | Type | Status | Location | Last Updated |
| -------- | ---- | ------ | -------- | ------------ |
| Tier Assessment (ART-ASS-191) | Tier Assessment | Complete | [ART-ASS-191](../../methodologies/documentation-tiers/assessments/ART-ASS-191-0-1-1-core-architecture.md) | 2026-02-20 |
| FDD (PD-FDD-022) | Functional Design | Complete | [fdd-0-1-1-core-architecture.md](../../../product-docs/functional-design/fdds/fdd-0-1-1-core-architecture.md) | 2026-02-19 |
| TDD (PD-TDD-021) | Technical Design | Complete | [tdd-0-1-1-core-architecture-t3.md](../../../product-docs/technical/architecture/design-docs/tdd/tdd-0-1-1-core-architecture-t3.md) | 2026-02-20 |
| ADR (PD-ADR-039) | Architecture Decision | Complete | [orchestrator-facade-pattern.md](../../../product-docs/technical/architecture/design-docs/adr/adr/orchestrator-facade-pattern-for-core-architecture.md) | 2026-02-20 |
| Test Spec (PF-TSP-035) | Test Specification | Complete | [test-spec-0-1-1-core-architecture.md](../../../../test/specifications/feature-specs/test-spec-0-1-1-core-architecture.md) | 2026-02-20 |

### Existing Project Documentation

| Document | Type | Relevant Content | Confirmed | Notes |
| -------- | ---- | ---------------- | --------- | ----- |
| HOW_IT_WORKS.md | Architecture Overview | System architecture, module responsibilities, data flow overview | **File Removed** | Was: full system design including service orchestration |
| [CHANGELOG.md](../../../../CHANGELOG.md) | Changelog | v2.0.0 restructure details, architecture changes | Confirmed | Documents major structural changes |
| [README.md](../../../../README.md) | Architecture Overview | Architecture section with module listing | Confirmed | High-level architecture summary |
| RESTRUCTURE_README.md | Architecture Overview | Technical architecture details for v2.0 restructure | **File Removed** | Was: detailed restructuring rationale |

### Quick Links

- **Main Design**: [TDD (PD-TDD-021)](../../../product-docs/technical/architecture/design-docs/tdd/tdd-0-1-1-core-architecture-t3.md)
- **Tier Assessment**: [ART-ASS-191](../../methodologies/documentation-tiers/assessments/ART-ASS-191-0-1-1-core-architecture.md)
- **Related Features**: [0.1.2 In-Memory Link Database](./0.1.2-in-memory-link-database-implementation-state.md), [0.1.3 Configuration System](./0.1.3-configuration-system-implementation-state.md)

---

## 5. Code Inventory

### Files Created by This Feature

| File Path | Purpose | Key Components | Status | Created |
| --------- | ------- | -------------- | ------ | ------- |
| [linkwatcher/service.py](../../../../linkwatcher/service.py) | Main orchestration service | `LinkWatcherService` class â€” lifecycle, scan, monitoring | Existing | Pre-framework |
| [linkwatcher/__init__.py](../../../../linkwatcher/__init__.py) | Package init, exports all public APIs | `__all__` list with all major classes | Existing | Pre-framework |
| [main.py](../../../../main.py) | CLI entry point, argument parsing, startup, duplicate instance prevention | `main()` function, argparse, config loading, `acquire_lock()`, `release_lock()`, `_is_pid_running()` | Existing | Pre-framework |
| [final.py](../../../../final.py) | Startup helper â€” changes directory before launching | `os.chdir` | Existing | Pre-framework |
| [linkwatcher/models.py](../../../../linkwatcher/models.py) | Core data models | `LinkReference` (dataclass), `FileOperation` (named tuple) | Existing | Pre-framework |
| [linkwatcher/utils.py](../../../../linkwatcher/utils.py) | Path utility functions | `normalize_path()`, `calculate_relative_path()`, `is_subpath()`, `should_monitor_file()` | Existing | Pre-framework |

### Files Modified by This Feature

N/A â€” Core architecture feature (foundational)

### Test Files

| Test File | Type | Coverage Areas | Status | Created |
| --------- | ---- | -------------- | ------ | ------- |
| [tests/unit/test_service.py](../../../../tests/unit/test_service.py) | Unit | Service lifecycle, orchestration | Existing | Pre-framework |
| tests/unit/test_models.py | Unit | Data model creation, equality, immutability | **Not Found on Disk** | Pre-framework |
| tests/unit/test_utils.py | Unit | Path normalization, relative paths, filtering | **Not Found on Disk** | Pre-framework |
| [tests/unit/test_lock_file.py](../../../../tests/unit/test_lock_file.py) | Unit | Lock file acquisition, release, stale/corrupt handling, PID check | Existing | 2026-02-25 |
| [tests/integration/test_comprehensive_file_monitoring.py](../../../../tests/integration/test_comprehensive_file_monitoring.py) | Integration | End-to-end service operation | Existing | Pre-framework |

### Database/Schema Changes

N/A â€” No traditional database (uses in-memory storage via feature 0.1.2)

---

## 6. Dependencies

### Feature Dependencies

**This Feature Depends On**:

- **[PF-FEA-047: In-Memory Link Database](./0.1.2-in-memory-link-database-implementation-state.md)** (MAINTAINED)
  - Why: Service holds a `LinkDatabase` instance as its central link store
  - Impact if unavailable: Service cannot track or query links

- **[PF-FEA-048: Configuration System](./0.1.3-configuration-system-implementation-state.md)** (MAINTAINED)
  - Why: Service accepts and applies `LinkWatcherConfig` at startup
  - Impact if unavailable: Service has no tunable behavior

- **[PF-FEA-049: File System Monitoring](./1.1.1-file-system-monitoring-implementation-state.md)** (MAINTAINED)
  - Why: Service creates watchdog Observer and registers LinkMaintenanceHandler
  - Impact if unavailable: Service cannot detect file system events

- **[PF-FEA-050: Link Parsing System](./2.1.1-link-parsing-system-implementation-state.md)** (MAINTAINED)
  - Why: Service uses `LinkParser` to scan files during initial scan
  - Impact if unavailable: Initial link discovery would fail

- **[PF-FEA-051: Link Updating](./2.2.1-link-updating-implementation-state.md)** (MAINTAINED)
  - Why: Service uses `LinkUpdater` to apply link changes to files
  - Impact if unavailable: Link updates could not be written

- **[PF-FEA-052: Logging System](./3.1.1-logging-system-implementation-state.md)** (MAINTAINED)
  - Why: Service uses `get_logger()` for structured operational logging
  - Impact if unavailable: No logging output

**Other Features Depend On This**:

- All features depend on the data models (`LinkReference`, `FileOperation`) defined in this feature
- All features that use path operations depend on `utils.py` from this feature
- `LinkWatcherService` is the top-level orchestrator â€” all other features are subsystems it coordinates

### System Dependencies

**Required Packages**:

| Package | Version | Purpose | Added |
| ------- | ------- | ------- | ----- |
| watchdog | â‰¥2.0 | File system event monitoring (Observer) | Pre-framework |
| colorama | â‰¥0.4 | Colored console output | Pre-framework |
| gitpython | â‰¥3.0 | Git repository detection (optional) | Pre-framework |

### Code Dependencies

**Existing Code This Feature Imports**:

| Component | Used For | Methods/APIs Used | Notes |
| --------- | -------- | ----------------- | ----- |
| linkwatcher/database.py | Link storage (service.py) | `LinkDatabase` | In-memory database |
| linkwatcher/handler.py | File event handling (service.py) | `LinkMaintenanceHandler` | Event processing |
| linkwatcher/parser.py | Link parsing (service.py) | `LinkParser` | File parsing |
| linkwatcher/updater.py | Link updating (service.py) | `LinkUpdater` | File updates |
| linkwatcher/logging.py | Logging (service.py, main.py) | `get_logger()`, `setup_logging()`, `LogLevel`, `LogTimer`, `with_context()` | Logging framework |
| linkwatcher/config/settings.py | Configuration (main.py) | `LinkWatcherConfig`, `DEFAULT_CONFIG` | Config management |

**Reverse Code Dependencies** (files that import this feature):

| Component | How They Use This Feature | Methods/APIs Used | Notes |
| --------- | ------------------------- | ----------------- | ----- |
| tests/unit/test_service.py | Unit tests for service | `LinkWatcherService` | Service testing |
| ../../../../tests/conftest.py | Test fixtures | `LinkWatcherService` | Shared test setup |
| tests/utils.py | Test utilities | `LinkWatcherService` | Test helper functions |
| tests/integration/*.py | Integration tests (5+ files) | `LinkWatcherService` | End-to-end testing |
| scripts/benchmark.py | Performance benchmarking | `LinkWatcherService` | Performance measurement |
| debug/*.py | Debug scripts (7 files) | `LinkWatcherService` | Development debugging |
| linkwatcher/database.py | Uses data models | `LinkReference` | Stores link references |
| linkwatcher/handler.py | Uses data models + utils | `FileOperation`, `normalize_path()` | Event processing |
| linkwatcher/parser.py | Uses data models | `LinkReference` | Creates link references |
| linkwatcher/updater.py | Uses data models + utils | `LinkReference`, `calculate_relative_path()` | Updates links |

---

## 7. Design Decisions

### Decision 1: Orchestrator/Facade Pattern for Service

**Date**: Pre-framework (discovered in code)
**Context**: The system has multiple independent subsystems (file watching, parsing, link storage, file updating, logging). A single coordination point was needed.

**Options Considered**:

1. Monolithic service: All logic in one class â€” simpler but harder to test and extend
2. Orchestrator/Facade: Service coordinates subsystems but contains no business logic â€” each subsystem independently testable
3. Event bus: Components communicate via events â€” more decoupled but adds complexity for a single-process tool

**Decision Made**: Orchestrator/Facade pattern (`LinkWatcherService`)

**Rationale**: `LinkWatcherService` instantiates all subsystems and manages their lifecycle (start/stop) but delegates all business logic to the appropriate subsystem. This makes unit testing straightforward and allows subsystems to evolve independently.

**Implications**:

- `service.py` is a thin coordinator â€” adding new capabilities means adding/modifying subsystems, not service.py
- All subsystems are created by service.py, making dependency injection straightforward for testing
- Public API is simple: `service.start()` and `service.stop()`

**Validation**: Confirmed by code inspection â€” service.py contains lifecycle management only; no parsing, link-update, or database logic. Documented in ADR PD-ADR-039.

---

### Decision 2: Signal Handler Registration at Service Level

**Date**: Pre-framework (discovered in code)
**Context**: The watchdog observer runs on a daemon thread. Clean shutdown requires explicit `observer.stop()` and `observer.join()` calls.

**Decision Made**: Register SIGTERM and SIGINT handlers in `LinkWatcherService._signal_handler()` during `start()`

**Rationale**: The service owns the observer lifecycle and is the appropriate place to handle shutdown signals.

**Implications**:

- Service can be embedded in other applications that manage their own signal handling
- Clean shutdown guaranteed on Ctrl+C and process termination

---

### Decision 3: Dataclass for LinkReference, Named Tuple for FileOperation

**Date**: Pre-framework (discovered in code)
**Context**: Two core data structures are needed system-wide: one for stored link records, one for file events.

**Decision Made**: `LinkReference` as `@dataclass`, `FileOperation` as `collections.namedtuple`

**Rationale**: LinkReference needs mutability for potential updates and has 5+ fields benefiting from dataclass features (default values, `__eq__`, `__repr__`). FileOperation is immutable event data with 3 fields â€” named tuple is lightweight and immutable by design.

**Implications**:

- LinkReference is hashable and comparable, enabling set operations in the database
- FileOperation is immutable, preventing accidental modification of in-flight events

---

### Decision 4: Pure Functions for Path Utilities

**Date**: Pre-framework (discovered in code)
**Context**: Path operations (normalization, relative path calculation, monitoring eligibility) are needed across multiple subsystems.

**Decision Made**: Stateless pure functions in `utils.py` â€” no class, no instance state

**Rationale**: Path operations have no side effects and need no shared state. Pure functions are trivially testable and can be imported by any module without coupling.

**Implications**:

- Any subsystem can import path utilities without introducing dependencies on other subsystems
- Testing is straightforward â€” input/output testing with no mocking required

---

### Implementation Patterns Used

**Orchestration Pattern**:

- Pattern: Orchestrator/Facade
- Why: Coordinates multiple subsystems without implementing their logic
- Where: `linkwatcher/service.py` (`LinkWatcherService`)

**Data Model Pattern**:

- Pattern: Dataclass + Named Tuple
- Why: Type-safe, immutable-where-appropriate domain objects
- Where: `linkwatcher/models.py`

**Utility Pattern**:

- Pattern: Stateless pure functions
- Why: No shared state needed for path manipulation
- Where: `linkwatcher/utils.py`

---

## 8. Issues & Resolutions Log

### Tech Debt and Known Limitations

| Item | Type | Reason | Current Mitigation | Priority | Estimated Effort | Future Resolution | Tracked In |
| ---- | ---- | ------ | ------------------ | -------- | ---------------- | ----------------- | ---------- |
| 4 potentially dead functions in utils.py | Tech Debt | Functions exist but may not be called | None | Low | 1 hour | Audit call sites and remove if unused | â€” |
| final.py purpose unclear | Known Limitation | Startup helper with `os.chdir` â€” role not fully documented | Works as-is | Low | 30 min | Document or consolidate into main.py | â€” |

---

## 9. Next Steps

**Last Updated**: 2026-02-21

### Immediate Next Actions

1. **Create remaining test specifications**
   - **Why**: Only PF-TSP-035 exists for this feature; models and utils coverage should be specified
   - **How**: Use Test Specification Creation task
   - **Estimate**: Medium

### Upcoming Work

- [ ] Audit dead functions in utils.py
- [ ] Investigate final.py purpose and consolidate if appropriate

---

## 10. Quality Metrics

**Last Updated**: 2026-02-25

### Test Coverage

**Unit Tests**: tests/unit/test_service.py, test_models.py, test_utils.py, test_lock_file.py â€” All passing
**Integration Tests**: tests/integration/ â€” Multiple files covering end-to-end service operation

---

## 11. API Documentation Reference

### Key Integration Points

**This Feature Exposes**:

- `LinkWatcherService` â€” Main service class (start/stop/scan)
- `LinkReference` â€” Data model for stored link records
- `FileOperation` â€” Data model for file move events
- `normalize_path()`, `calculate_relative_path()`, `is_subpath()`, `should_monitor_file()` â€” Path utilities
- `acquire_lock()`, `release_lock()`, `_is_pid_running()` â€” Duplicate instance prevention (main.py)

**This Feature Requires**:

- `LinkDatabase` (database.py)
- `LinkParser` (parser.py)
- `LinkUpdater` (updater.py)
- `LinkMaintenanceHandler` (handler.py)
- `LinkWatcherConfig` (config/settings.py)

---

## 12. Lessons Learned

_Retrospective â€” no lessons captured during original implementation (pre-framework)._
